{% extends 'admin/adminindex.html' %}

{% block body %}
  <div class="container py-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h3 mb-0">Edit Student</h1>
      <a href="/view_student" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i> Back to Student List</a>
    </div>

    <!-- Registration Form Card -->
    <div class="card shadow-sm">
      <div class="card-body">
        <form method="post" action="/update_student" enctype="multipart/form-data" class="student-edit-form" novalidate>
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="lid" value="{{ i['lid'] }}">
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="name" class="form-label">Name</label>
              <input type="text" name="text1" class="form-control" id="name" value="{{ i['name'] if i else '' }}" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="regno" class="form-label">Registration No</label>
              <input type="text" name="text2" class="form-control" id="regno" value="{{ i['regno'] if i else '' }}" required>
            </div>
          </div>

          <div class="mb-3">
            <label for="address" class="form-label">Address</label>
            <textarea name="text3" class="form-control" id="address" rows="3" required>{{ i['address'] if i else '' }}</textarea>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="phone" class="form-label">Phone</label>
              <input type="text" name="text4" class="form-control" id="phone" value="{{ i['phone'] if i else '' }}" required>
            </div>

            <div class="col-md-6 mb-3">
              <label for="email" class="form-label">Email</label>
              <input type="email" name="text5" class="form-control" id="email" value="{{ i['email'] if i else '' }}" required>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="dob" class="form-label">Date of Birth</label>
              <input type="date" name="text6" class="form-control" id="dob" value="{{ i['dob'] if i else '' }}" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="department" class="form-label">Department</label>
              <select name="select" id="department" class="form-select" required>
                <option disabled {% if not i %}selected{% endif %}>-- Department --</option>
                {% for d in dept %}
                <option value="{{ d.department_name }}" {% if i and i['department'] == d.department_name %}selected{% endif %}>{{ d.department_name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="semester" class="form-label">Semester</label>
              <select name="select1" id="semester" class="form-select" required>
                <option disabled>-- Semester --</option>
                {% for s in range(1,9) %}
                  <option {% if i['semester']==s %} selected {% endif %}>{{ s }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="division" class="form-label">Division</label>
              <input type="text" name="select3" class="form-control" id="division" value="{{ i['division'] if i else '' }}" required>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="guardian" class="form-label">Guardian Name</label>
              <input type="text" name="guardian" class="form-control" id="guardian" value="{{ i['gname'] if i else '' }}" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="guardian_phone" class="form-label">Guardian Phone</label>
              <input type="text" name="phone" class="form-control" id="guardian_phone" value="{{ i['gnumber'] if i else '' }}" required>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Gender</label>
            <div class="d-flex">
                <div class="form-check me-3">
                    <input class="form-check-input" type="radio" name="gender" id="male" value="Male" {% if i and i['gender'] == 'Male' %}checked{% endif %} required>
                    <label class="form-check-label" for="male">Male</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="gender" id="female" value="Female" {% if i and i['gender'] == 'Female' %}checked{% endif %}>
                    <label class="form-check-label" for="female">Female</label>
                </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="photo" class="form-label">Photo</label>
            {% if i and i['photo'] %}
            <div class="mb-2">
              <img src="{{ url_for('static', filename='photos/studentphoto/' + i['photo']) }}" alt="Student Photo" class="img-thumbnail" width="150">
            </div>
            {% endif %}
            <input type="file" name="files" class="form-control" id="photo">
          </div>

          <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i> Update</button>
        </form>
      </div>
    </div>

  </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.querySelector('.student-edit-form');

    form.addEventListener('submit', function (e) {
        let isValid = true;

        // Clear previous errors
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        document.querySelectorAll('.invalid-feedback').forEach(el => el.remove());

        // Helper function to show error
        function showError(input, message) {
            isValid = false;
            input.classList.add('is-invalid');
            const error = document.createElement('div');
            error.className = 'invalid-feedback';
            error.textContent = message;
            // Insert error after the input element
            input.parentNode.insertBefore(error, input.nextSibling);
        }

        // 1. Check required text inputs and textareas
        const requiredFields = [
            { id: 'name', name: 'Name' },
            { id: 'regno', name: 'Registration No' },
            { id: 'address', name: 'Address' },
            { id: 'phone', name: 'Phone' },
            { id: 'email', name: 'Email' },
            { id: 'dob', name: 'Date of Birth' },
            { id: 'division', name: 'Division' },
            { id: 'guardian', name: 'Guardian Name' },
            { id: 'guardian_phone', name: 'Guardian Phone' }
        ];

        requiredFields.forEach(item => {
            const input = document.getElementById(item.id);
            if (input && !input.value.trim()) {
                showError(input, `${item.name} is required.`);
            }
        });

        // 2. Check email format
        const emailInput = document.getElementById('email');
        if (emailInput && emailInput.value.trim()) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(emailInput.value)) {
                showError(emailInput, 'Please enter a valid email address.');
            }
        }

        // 3. Check phone number format (simple check for digits)
        const phoneInput = document.getElementById('phone');
        const guardianPhoneInput = document.getElementById('guardian_phone');
        if (phoneInput && phoneInput.value.trim()) {
            const phoneRegex = /^\d{10,15}$/;
            if (!phoneRegex.test(phoneInput.value)) {
                showError(phoneInput, 'Please enter a valid phone number (10-15 digits).');
            }
        }
        if (guardianPhoneInput && guardianPhoneInput.value.trim()) {
            const phoneRegex = /^\d{10,15}$/;
            if (!phoneRegex.test(guardianPhoneInput.value)) {
                showError(guardianPhoneInput, 'Please enter a valid phone number (10-15 digits).');
            }
        }

        // 4. Check select fields
        const selectFields = [
            { id: 'department', name: 'Department' },
            { id: 'semester', name: 'Semester' }
        ];

        selectFields.forEach(item => {
            const select = document.getElementById(item.id);
            if (select && (select.value.startsWith('--') || !select.value)) {
                showError(select, `Please select a ${item.name}.`);
            }
        });

        // 5. Check gender radio buttons
        const genderSelected = document.querySelector('input[name="gender"]:checked');
        if (!genderSelected) {
            const genderContainer = document.querySelector('input[name="gender"]').closest('.mb-3');
            const error = document.createElement('div');
            error.className = 'invalid-feedback d-block';
            error.textContent = 'Please select a gender.';
            genderContainer.appendChild(error);
            isValid = false;
        }

        if (!isValid) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}
